  <!-- ESTAD칈STICAS + BOT칍N DE EXPORTAR (solo visible para ti o quien conozca la URL) -->
  <div class="exp-card" id="estadisticas-admin" style="margin-top:30px; background:#e8f0fe;">
    <h2>游늵 Estad칤sticas de uso (solo administradores)</h2>
    <p>Total de descargas hasta ahora: <strong id="total-descargas">0</strong></p>
    
    <details style="margin-top:15px;">
      <summary>Ver detalle por archivo</summary>
      <div id="detalle-archivos" style="margin-top:10px; font-size:14px;"></div>
    </details>

    <button id="btn-exportar" class="boton-enviar" style="margin-top:15px; background:#34a853;">
      游닌 Exportar todo (descargas + comentarios) a CSV
    </button>
    <p style="font-size:12px; margin-top:8px;">
      Este bot칩n solo funciona si est치s autenticado como administrador (se te pedir치 login r치pido con Google).
    </p>
  </div>

  <!-- COMENTARIOS (estilo blog) -->
  <div class="exp-card" id="comentarios-blog">
    <!-- ... el formulario y lista que ya ten칤as ... -->
  </div>
</div>

<script type="module">
  // ... TODO el c칩digo anterior que ya ten칤as (Firebase, contadores, comentarios) se mantiene igual ...

  /* ============= NUEVO: ESTAD칈STICAS Y EXPORTACI칍N ============= */

  // 1. Mostrar total y detalle de descargas
  const totalSpan = document.getElementById("total-descargas");
  const detalleDiv = document.getElementById("detalle-archivos");

  let totalGlobal = 0;
  const conteos = {}; // para guardar cada archivo y su conteo

  function actualizarEstadisticas() {
    onSnapshot(collection(db, "downloads"), snapshot => {
      totalGlobal = 0;
      detalleDiv.innerHTML = "";

      const filas = [];
      snapshot.forEach(doc => {
        const nombre = doc.id;
        const count = doc.data().count || 0;
        conteos[nombre] = count;
        totalGlobal += count;

        // nombre bonito para mostrar
        const bonito = nombre
          .replace("exp1-", "Exp 1 - ")
          .replace("exp2-", "Exp 2 - ")
          .replace("exp3-", "Exp 3 - ")
          .replace("guia.pdf", "Gu칤a")
          .replace("observacion-docente.pdf", "Observaci칩n docente")
          .replace("reflexion-estudiante.pdf", "Reflexi칩n estudiante")
          .replace(".pdf", "");

        filas.push(`<div style="display:flex;justify-content:space-between;"><span>${bonito}</span><strong>${count}</strong></div>`);
      });

      totalSpan.textContent = totalGlobal;
      detalleDiv.innerHTML = filas.join("");
    });
  }

  actualizarEstadisticas();

  // 2. BOT칍N DE EXPORTAR TODO (descargas + comentarios) a CSV
  document.getElementById("btn-exportar").addEventListener("click", async () => {
    // Peque침a autenticaci칩n con Google (solo t칰 la pasar치s)
    // Si no est치s logueado te pedir치 login r치pido y solo t칰 tienes permiso
    try {
      const { getAuth, signInWithPopup, GoogleAuthProvider } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js");
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      // Forzamos login (solo t칰 tienes permiso en las reglas de Firestore)
      await signInWithPopup(auth, provider);

      // Una vez logueado, descargamos todo
      const descargasSnap = await getDocs(collection(db, "downloads"));
      const comentariosSnap = await getDocs(query(collection(db, "comments"), orderBy("createdAt", "desc")));

      let csv = "Tipo,Experiencia,Archivo/Tipo,Descargas,Fecha,Nombre,Correo,Comentario\n";

      // DESCARGAS
      descargasSnap.forEach(doc => {
        const archivo = doc.id;
        const count = doc.data().count || 0;
        let exp = "";
        if (archivo.includes("exp1")) exp = "1";
        else if (archivo.includes("exp2")) exp = "2";
        else if (archivo.includes("exp3")) exp = "3";

        let tipo = "";
        if (archivo.includes("guia")) tipo = "Gu칤a escrita";
        else if (archivo.includes("observacion-docente")) tipo = "Plantilla observaci칩n docente";
        else if (archivo.includes("reflexion-estudiante")) tipo = "Plantilla reflexi칩n estudiante";

        csv += `Descarga,${exp},${tipo},${count},,,,,\n`;
      });

      // COMENTARIOS
      comentariosSnap.forEach(doc => {
        const d = doc.data();
        const fecha = d.createdAt ? new Date(d.createdAt).toLocaleString() : "";
        csv += `Comentario,,,,${fecha},${d.name},${d.email},"${d.comment.replace(/"/g, '""')}",\n`;
      });

      // Generar y forzar descarga
      const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `estadisticas-experiencias-${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      alert("춰Archivo CSV descargado correctamente!");
    } catch (err) {
      console.error(err);
      alert("Error al exportar. Aseg칰rate de haber iniciado sesi칩n con tu cuenta de Google que tiene acceso al proyecto.");
    }
  });
</script>
